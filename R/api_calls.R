# these functions heavily inspired by code from @fchen365

# TODO: vectorize all these / make bigger requests instead of just
# a single request

# TODO: some sort of safe_lookup_users() at some point

#' Get the user IDs of all nodes in a user's neighborhood
#'
#' @param node Either the screen name of user ID of a Twitter user.
#'
#' @return A character vector of user IDs. May be empty if the user
#'   doesn't follow anyone.
#'
#' @export
#'
get_neighborhood <- function(user) {
  .NotYetImplemented()
}

#' Title
#'
#' @return TODO
#' @export
#' @importFrom dplyr filter %>%
#'
#' @family API call
#'
check_rate_limits <- function() {

  tokens <- get_all_tokens()

  rtweet::rate_limits(tokens) %>%
    filter(query %in% c("friends/ids", "followers/ids", "users/lookup"))

}

#' Title
#'
#' @param query TODO
#'
#' @return TODO
#' @export
#' @importFrom dplyr filter %>%
#'
#' @family API call
#'
find_token <- function(query = "friends/ids") {

  tokens <- get_all_tokens()

  limits <- rtweet::rate_limits(tokens) %>%
    filter(query == !!query)

  calls_remaining <- any(limits$remaining > 0)

  # wait the shortest amount of time for the query to reset
  if (!calls_remaining) {
    minutes_until_reset <- min(limits$reset)
    message(glue("API calls exhausted. Waiting {minutes_until_reset * 60} seconds."))
    Sys.sleep(minutes_until_reset * 60)
    return(find_token(query))
  }

  # return the token with most remaining calls
  index <- which.max(limits$remaining)
  tokens[[index]]
}

#' Title
#'
#' @param node
#' @param ...
#'
#' @return
#' @export
#'
#' @family API call
#'
safe_get_friends <- function(node, ...) {

  stopifnot(length(node) == 1)

  token <- find_token("friends/ids")
  friends <- rtweet::get_friends(node, token = token, verbose = FALSE, ...)

  if (nrow(friends) == 0)
    return(empty_edgelist())

  colnames(friends) <- c("from", "to")
  friends
}

#' Title
#'
#' @param node
#' @param ...
#'
#' @return
#' @export
#'
#' @family API call
#'
safe_get_followers <- function(node, ...) {

  stopifnot(length(node) == 1)

  token <- find_token("followers/ids")
  followers <- rtweet::get_followers(node, token = token, verbose = FALSE, ...)

  if (all(is.na(followers$user_id)))
    return(empty_edgelist())

  colnames(followers) <- "from"
  followers$to <- node

  followers
}

#' Title
#'
#' @param node
#' @param ...
#'
#' @return
#' @export
#'
#' @family API call
#'
safe_lookup_user <- function(node, ...) {
  stopifnot(length(node) == 1)
  token <- find_token("users/lookup")
  rtweet::lookup_users(node, token = token)
}
